<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Been Kosova - Track Your Visits</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Been Kosova</h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Visited:</span>
                    <span class="stat-value" id="visited-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="total-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Completion:</span>
                    <span class="stat-value" id="completion-rate">0%</span>
                </div>
            </div>
        </header>

        <div class="legend-container" id="legend-container"></div>

        <div class="map-container">
            <svg id="kosovo-map"></svg>
        </div>

        <!-- Checklist Panel -->
        <div class="checklist-panel" id="checklist-panel">
            <div class="checklist-header">
                <h2 id="checklist-title">Select a Municipality</h2>
                <button class="close-btn" id="close-checklist">&times;</button>
            </div>
            <div class="checklist-content" id="checklist-content">
                <p class="checklist-placeholder">Click on a municipality to see places you've visited there</p>
            </div>
        </div>

        <div class="city-list">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="cities-section">
                <h2 class="cities-header" id="cities-header">
                    Cities
                    <svg class="header-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M6 9L1 4h10z" fill="currentColor" />
                    </svg>
                </h2>
                <div class="cities-grid" id="cities-container"></div>
            </div>
        </div>
    </div>

    <script src="kosovo-regions.js"></script>
    <script src="kosovo-polygons.js"></script>
    <script>
        // Places data for each municipality
        const municipalityPlaces = {
            "prishtina": [
                "Mother Teresa Square",
                "Newborn Monument",
                "National Library",
                "Ethnographic Museum",
                "Germia Park",
                "Prishtina City Center",
                "Bill Clinton Boulevard",
                "Cathedral of Saint Mother Teresa"
            ],
            "prizren": [
                "Prizren Fortress",
                "Old Stone Bridge",
                "Sinan Pasha Mosque",
                "Our Lady of Ljeviš",
                "Shadervan Square",
                "League of Prizren Museum",
                "Gazi Mehmet Pasha Hammam"
            ],
            "peja": [
                "Patriarchate of Peć",
                "Rugova Gorge",
                "Peja Bazaar",
                "Bajrakli Mosque",
                "Peja Museum",
                "Radavc Cave"
            ],
            "gjakova": [
                "Old Bazaar",
                "Hadum Mosque",
                "Clock Tower",
                "Gjakova Cathedral",
                "Ethnographic Museum"
            ],
            "mitrovica": [
                "Ibar River Bridge",
                "Mitrovica Clock Tower",
                "Miners' Monument",
                "City Center"
            ],
            "ferizaj": [
                "City Park",
                "Ferizaj Museum",
                "Old Bazaar",
                "Clock Tower"
            ],
            "gjilan": [
                "Gjilan City Center",
                "Ethnographic Museum",
                "City Park"
            ],
            "kline": [
                "Kline City Center",
                "Drini i Bardhë River"
            ],
            "istog": [
                "Istog City Center",
                "Istog Lake"
            ],
            "decan": [
                "Visoki Dečani Monastery",
                "Deçan City Center"
            ],
            "skenderaj": [
                "Adem Jashari Memorial",
                "Skenderaj City Center"
            ],
            "vushtrri": [
                "Vushtrri Castle",
                "City Center"
            ],
            "podujeva": [
                "Podujeva City Center",
                "Monument of Fallen Heroes"
            ],
            "lipjan": [
                "Lipjan City Center",
                "Ulpiana Archaeological Site"
            ],
            "gracanica": [
                "Gračanica Monastery",
                "City Center"
            ],
            "suhareka": [
                "Suhareka City Center",
                "Old Bazaar"
            ],
            "dragash": [
                "Sharri Mountains",
                "Dragash City Center"
            ],
            "kamenica": [
                "Kamenica City Center",
                "City Park"
            ],
            "gjilan": [
                "Gjilan City Center",
                "Ethnographic Museum"
            ]
        };

        // Storage keys
        const STORAGE_KEY = 'beenKosova_visited';
        const PLACES_STORAGE_KEY = 'beenKosova_places';

        // Use polygon data
        const cities = Object.keys(kosovoPolygons).map(id => ({
            id: id,
            name: kosovoPolygons[id].name,
            region: kosovoPolygons[id].region
        }));

        // Initialize visited cities
        let visitedCities = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if (!Array.isArray(visitedCities)) {
            visitedCities = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(visitedCities));
        }

        // Initialize visited places
        let visitedPlaces = JSON.parse(localStorage.getItem(PLACES_STORAGE_KEY) || '{}');
        if (typeof visitedPlaces !== 'object' || Array.isArray(visitedPlaces)) {
            visitedPlaces = {};
            localStorage.setItem(PLACES_STORAGE_KEY, JSON.stringify(visitedPlaces));
        }

        // Validate visited cities
        const validCityIds = Object.keys(kosovoPolygons);
        const originalLength = visitedCities.length;
        visitedCities = visitedCities.filter(id => validCityIds.includes(id));
        if (visitedCities.length !== originalLength) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(visitedCities));
        }

        // Calculate center point of polygon for label placement
        function getPolygonCenter(coordsString) {
            const coords = coordsString.split(',').map(Number);
            let sumX = 0, sumY = 0;
            for (let i = 0; i < coords.length; i += 2) {
                sumX += coords[i];
                sumY += coords[i + 1];
            }
            return {
                x: sumX / (coords.length / 2),
                y: sumY / (coords.length / 2)
            };
        }

        function drawMap() {
            const svg = d3.select("#kosovo-map");
            svg.selectAll("*").remove();

            // Set SVG viewBox
            let maxX = 0, maxY = 0;
            Object.values(kosovoPolygons).forEach(poly => {
                const coords = poly.coords.split(',').map(Number);
                for (let i = 0; i < coords.length; i += 2) {
                    maxX = Math.max(maxX, coords[i]);
                    maxY = Math.max(maxY, coords[i + 1]);
                }
            });

            const viewBoxWidth = Math.ceil(maxX * 1.1);
            const viewBoxHeight = Math.ceil(maxY * 1.1);

            svg.attr("viewBox", `0 0 ${viewBoxWidth} ${viewBoxHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            // Add filter for glow effect
            const defs = svg.append("defs");
            const glowFilter = defs.append("filter")
                .attr("id", "glow")
                .attr("x", "-50%")
                .attr("y", "-50%")
                .attr("width", "200%")
                .attr("height", "200%");

            glowFilter.append("feGaussianBlur")
                .attr("stdDeviation", "3")
                .attr("result", "coloredBlur");

            const feMerge = glowFilter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // Draw Kosovo background
            svg.append("rect")
                .attr("width", viewBoxWidth)
                .attr("height", viewBoxHeight)
                .attr("fill", "#f9fafb");

            // Draw clickable polygons
            const municipalityData = Object.keys(kosovoPolygons).map(id => ({
                id: id,
                ...kosovoPolygons[id],
                center: getPolygonCenter(kosovoPolygons[id].coords)
            }));

            const municipalityPolygons = svg.selectAll(".municipality")
                .data(municipalityData)
                .enter()
                .append("g")
                .attr("class", "municipality-group");

            municipalityPolygons.append("path")
                .attr("class", "city")
                .attr("id", d => d.id)
                .attr("d", d => coordsToPath(d.coords))
                .attr("data-city", d => d.name)
                .attr("data-region", d => d.region)
                .attr("fill", d => {
                    const regionColor = kosovoMapData.regions[d.region].color;
                    return visitedCities.includes(d.id) ? "#16a34a" : regionColor;
                })
                .attr("fill-opacity", d => visitedCities.includes(d.id) ? 0.7 : 0.3)
                .attr("stroke", d => {
                    const regionColor = kosovoMapData.regions[d.region].color;
                    return visitedCities.includes(d.id) ? "#16a34a" : regionColor;
                })
                .attr("stroke-width", "1.5")
                .attr("stroke-opacity", "0.8")
                .attr("filter", d => visitedCities.includes(d.id) ? "url(#glow)" : null)
                .attr("cursor", "pointer")
                .on("click", function (event, d) {
                    showChecklist(d.id, d.name);
                })
                .on("mouseenter", function (event, d) {
                    const regionColor = kosovoMapData.regions[d.region].color;
                    d3.select(this)
                        .attr("stroke-width", "2.5")
                        .attr("fill-opacity", visitedCities.includes(d.id) ? 0.8 : 0.4);
                })
                .on("mouseleave", function (event, d) {
                    d3.select(this)
                        .attr("stroke-width", "1.5")
                        .attr("fill-opacity", visitedCities.includes(d.id) ? 0.7 : 0.3);
                });

            // Add municipality name labels
            municipalityPolygons.append("text")
                .attr("class", "municipality-label")
                .attr("x", d => d.center.x)
                .attr("y", d => d.center.y)
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("font-size", "10px")
                .attr("font-weight", "500")
                .attr("fill", "#1a202c")
                .attr("pointer-events", "none")
                .text(d => d.name);

            municipalityPolygons.append("title")
                .text(d => d.name);

            createLegend();
        }

        function createLegend() {
            const legendContainer = document.getElementById('legend-container');
            if (!legendContainer) return;

            legendContainer.innerHTML = '';

            const title = document.createElement('h3');
            title.className = 'legend-title';
            title.textContent = 'RAJONET';
            legendContainer.appendChild(title);

            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'legend-items';

            Object.entries(kosovoMapData.regions).forEach(([key, region]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = region.color;

                const label = document.createElement('span');
                label.className = 'legend-label';
                label.textContent = region.name;

                item.appendChild(colorBox);
                item.appendChild(label);
                itemsContainer.appendChild(item);
            });

            legendContainer.appendChild(itemsContainer);
        }

        function showChecklist(municipalityId, municipalityName) {
            const panel = document.getElementById('checklist-panel');
            const title = document.getElementById('checklist-title');
            const content = document.getElementById('checklist-content');

            title.textContent = municipalityName;
            content.innerHTML = '';

            // Get places for this municipality
            const places = municipalityPlaces[municipalityId] || ["No specific places listed"];

            // Get visited places for this municipality
            if (!visitedPlaces[municipalityId]) {
                visitedPlaces[municipalityId] = [];
            }

            // Create checklist
            const checklist = document.createElement('div');
            checklist.className = 'places-checklist';

            places.forEach(place => {
                const placeItem = document.createElement('div');
                placeItem.className = 'place-item';

                const isVisited = visitedPlaces[municipalityId].includes(place);

                placeItem.innerHTML = `
                    <label class="place-checkbox-label">
                        <input type="checkbox" class="place-checkbox" ${isVisited ? 'checked' : ''} 
                               data-place="${place}" data-municipality="${municipalityId}">
                        <span class="checkmark"></span>
                        <span class="place-name ${isVisited ? 'visited' : ''}">${place}</span>
                    </label>
                `;

                const checkbox = placeItem.querySelector('.place-checkbox');
                checkbox.addEventListener('change', function () {
                    togglePlace(municipalityId, place, this.checked);
                    const placeNameSpan = placeItem.querySelector('.place-name');
                    if (this.checked) {
                        placeNameSpan.classList.add('visited');
                    } else {
                        placeNameSpan.classList.remove('visited');
                    }
                });

                checklist.appendChild(placeItem);
            });

            content.appendChild(checklist);
            panel.classList.add('active');
        }

        function togglePlace(municipalityId, placeName, isVisited) {
            if (!visitedPlaces[municipalityId]) {
                visitedPlaces[municipalityId] = [];
            }

            if (isVisited) {
                if (!visitedPlaces[municipalityId].includes(placeName)) {
                    visitedPlaces[municipalityId].push(placeName);
                }
            } else {
                visitedPlaces[municipalityId] = visitedPlaces[municipalityId].filter(p => p !== placeName);
            }

            localStorage.setItem(PLACES_STORAGE_KEY, JSON.stringify(visitedPlaces));
        }

        function updateUI() {
            d3.selectAll(".city")
                .attr("fill", function () {
                    const id = d3.select(this).attr("id");
                    const region = d3.select(this).attr("data-region");
                    const regionColor = kosovoMapData.regions[region]?.color || "#d1d5db";
                    return visitedCities.includes(id) ? "#16a34a" : regionColor;
                })
                .attr("fill-opacity", function () {
                    const id = d3.select(this).attr("id");
                    return visitedCities.includes(id) ? 0.7 : 0.3;
                })
                .attr("stroke", function () {
                    const id = d3.select(this).attr("id");
                    const region = d3.select(this).attr("data-region");
                    const regionColor = kosovoMapData.regions[region]?.color || "#d1d5db";
                    return visitedCities.includes(id) ? "#16a34a" : regionColor;
                })
                .attr("stroke-width", "1.5")
                .attr("stroke-opacity", "0.8")
                .attr("filter", function () {
                    const id = d3.select(this).attr("id");
                    return visitedCities.includes(id) ? "url(#glow)" : null;
                });

            updateCityList();
            updateStats();
        }

        function updateCityList() {
            const container = document.getElementById('cities-container');
            if (!container) return;

            container.innerHTML = '';

            const sortedCities = [...cities].sort((a, b) => {
                if (a.region !== b.region) {
                    return a.region.localeCompare(b.region);
                }
                return a.name.localeCompare(b.name);
            });

            sortedCities.forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.className = `city-item ${visitedCities.includes(city.id) ? 'visited' : ''}`;
                cityItem.innerHTML = `
                    <div class="city-checkbox"></div>
                    <span>${city.name}</span>
                `;

                cityItem.addEventListener('click', () => {
                    toggleCity(city.id);
                    showChecklist(city.id, city.name);
                });
                container.appendChild(cityItem);
            });
        }

        function updateStats() {
            const visitedCount = visitedCities.length;
            const totalCount = cities.length;
            const completionRate = totalCount > 0 ? Math.min(100, Math.round((visitedCount / totalCount) * 100)) : 0;

            document.getElementById('visited-count').textContent = visitedCount;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;

            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${completionRate}%`;
            }
        }

        function toggleCity(cityId) {
            const index = visitedCities.indexOf(cityId);
            if (index > -1) {
                visitedCities.splice(index, 1);
            } else {
                visitedCities.push(cityId);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(visitedCities));
            updateUI();
        }

        function setupCitiesToggle() {
            const header = document.getElementById('cities-header');
            const grid = document.querySelector('.cities-grid');

            if (header && grid) {
                grid.classList.remove('show');
                header.classList.remove('active');

                header.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isActive = grid.classList.toggle('show');
                    header.classList.toggle('active', isActive);
                });
            }
        }

        // Close checklist panel
        document.getElementById('close-checklist').addEventListener('click', function () {
            document.getElementById('checklist-panel').classList.remove('active');
        });

        // Close checklist when clicking outside
        document.addEventListener('click', function (e) {
            const panel = document.getElementById('checklist-panel');
            if (panel.classList.contains('active') && !panel.contains(e.target) &&
                !e.target.closest('.city') && !e.target.closest('.city-item')) {
                panel.classList.remove('active');
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            drawMap();
            updateUI();
            setupCitiesToggle();
        });
    </script>
</body>

</html>